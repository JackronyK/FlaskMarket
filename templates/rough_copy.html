from models import Admins, AdminActionLog
from flask import request, session, redirect, url_for, flash, render_template

@app.route('/admin/manage', methods=['GET', 'POST'])
@super_admin_required
def super_admin_manage():
    admins = Admins.query.all()

    if request.method == 'POST':
        admin_id = request.form.get('admin_id')
        action = request.form.get('action')
        target_admin = Admins.query.get_or_404(admin_id)

        try:
            notes = ""
            if action == 'promote':
                target_admin.is_super_admin = True
                notes = f"Promoted {target_admin.name} to Super Admin"
                flash(f"✅ Admin {target_admin.name} promoted to Super Admin.", "success")

            elif action == 'delete':
                notes = f"Deleted admin account of {target_admin.name}"
                db.session.delete(target_admin)
                flash(f"🗑️ Admin {target_admin.name} deleted successfully.", "warning")

            # Save admin action log
            log = AdminActionLog(
                log_id=AdminActionLog.generate_log_id(),
                action=action,
                target_admin_id=target_admin.admin_id,
                performed_by_admin_id=session.get('admin_id'),
                notes=notes
            )
            db.session.add(log)
            db.session.commit()

        except Exception as e:
            db.session.rollback()
            flash(f"❌ Error: {str(e)}", "danger")

        return redirect(url_for('super_admin_manage'))

    return render_template('admin/super_admin_manage.html', admins=admins)
